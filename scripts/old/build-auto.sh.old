#!/bin/bash

export PATH=/home/user/bin:/home/user/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin
export USE_CCACHE=1
export CCACHE_COMPRESS=true

HOUR=`date +%H`

BASE_ROOT=/home/user/hdd1/auto-builder/
LOCK_FILE=$BASE_ROOT/tmp/build.lock
REMOTE_BUSY_LOCK=$BASE_ROOT/var/lock/remote/remote_busy.lock
LOCAL_BUSY_LOCK=$BASE_ROOT/var/lock/local/local_busy.lock
LOCAL_SOURCE_ROOT=/home/user/hdd1/
TEST_UPDATES_ROOT=$BASE_ROOT/test-updates/
SCRIPT_ROOT=$BASE_ROOT/scripts/
LOG_ROOT=$BASE_ROOT/var/log/

source $BASE_ROOT/etc/config.sh

if [ -f $LOCK_FILE ]; then
        fpid=`cat $LOCK_FILE`
        ps ax | grep -v grep | grep $fpid | grep "$(basename "$0")"
        if [ $? -eq 0 ]; then
                echo build-auto is already running
                exit 1
        fi
fi
echo $$ > $LOCK_FILE

check_load () {
echo sleep 600
sleep 600
load_avg=`cat /proc/loadavg | cut -d " " -f 3`
load_int=`echo $load_avg/1 | bc`
if [ $load_int -ne 0 ]; then
       	echo load too high. exiting
       	echo load high - `date` >> ~/build-auto.log
       	exit 1
fi
echo sleep 300
sleep 300
load_avg=`cat /proc/loadavg | cut -d " " -f 3`
load_int=`echo $load_avg/1 | bc`
if [ $load_int -ne 0 ]; then
        echo load too high. exiting
        echo load high - `date` >> ~/build-auto.log
        exit 1
fi
echo sleep 300
sleep 300
load_avg=`cat /proc/loadavg | cut -d " " -f 3`
load_int=`echo $load_avg/1 | bc`
if [ $load_int -ne 0 ]; then
        echo load too high. exiting
        echo load high - `date` >> ~/build-auto.log
        exit 1
fi
}

echo running - `date` >> $LOG_ROOT/build-auto.log

# Disable for testing
#check_load

for i in crDroidAndroid-14 crDroidAndroid-15 lineage-20 lineage-21 lineage-22 RisingOS ; do
	cd $LOCAL_SOURCE_ROOT/$i
	cp .backup/repo-sync.sh .
	cp .backup/config .
	cp .backup/confiq.sh .
	cp .backup/config-rom.sh .
	repo --version
	cd .repo/repo
	git pull -r
	cd -
	bash $SCRIPT_ROOT/resync-network.sh	
	repo sync -n -j 4
	if [ $? -ne 0 ] ; then bash repo-sync.sh network ;fi
        unset REPO_URL
        unset REPO_BRANCH
done

cd $TEST_UPDATES_ROOT

for i in crDroidAndroid-14 crDroidAndroid-15 lineage-21 lineage-20 lineage-22 RisingOS ; do
	cd $TEST_UPDATES_ROOT
	if grep "$i" $REMOTE_BUSY_LOCK || grep "$i" $LOCAL_BUSY_LOCK ; then echo "skipping $i" ; continue ; fi
	bash $i.sh
	if [ $? -eq 0 ]; then
		if ! ls $REMOTE_BUSY_LOCK; then
			echo queue remote
			touch $REMOTE_BUSY_LOCK
			echo $i > $REMOTE_BUSY_LOCK
			cd $CRAVE_ROOT/$i
			screen -dmS build-remote bash begin-$i.sh 
		elif ! ls $LOCAL_BUSY_LOCK; then
			echo queue local
			check_load
			touch $LOCAL_BUSY_LOCK
			echo $i > $LOCAL_BUSY_LOCK
			screen -dmS build-local bash $SCRIPT_ROOT/auto-builder.sh $LOCAL_SOURCE_ROOT/$i
			# eg:
			# check_load
			# $SCRIPT_ROOT/auto-builder.sh $LOCAL_SOURCE_ROOT/$i
			# if ls $LOCAL_SUCCESS ;then
			#     do stuff
			# fi
		else
			break
		fi
	fi
done	

exit 0

#
# ^ stopped work on this script here
#

export USE_CCACHE=1
export CCACHE_COMPRESS=true


if bash crDroid-10.sh; then
  cd /home/user/hdd1/crDroid-10/
  if bash repo-sync.sh; then
    bash builder.sh
    if [ $? -ne 0 ]; then read -p 'press enter:'; exit 1; fi
  fi
fi
if [ $HOUR -eq 22 ] || [ $HOUR -eq 10 ]; then
  cd /home/user/hdd1/crDroid-10/
  bash repo-sync.sh
fi
cd $BASE_DIR

if bash crDroid-11.sh; then
  cd /home/user/hdd1/crDroid-11/
  if bash repo-sync.sh; then
    bash builder.sh
    if [ $? -ne 0 ]; then read -p 'press enter:'; exit 1; fi
  fi
fi
if [ $HOUR -eq 22 ] || [ $HOUR -eq 10 ]; then
  cd /home/user/hdd1/crDroid-11/
  bash repo-sync.sh
fi
cd $BASE_DIR

if bash lineage-21.sh; then
  cd /home/user/hdd1/lineage-21.0/
  if bash repo-sync.sh; then
    bash builder-user.sh
    if [ $? -ne 0 ]; then read -p 'lineage-21 user: press enter:'; exit 1; fi
    bash builder-userdebug.sh
    if [ $? -ne 0 ]; then read -p 'lineage-21 userdebug: press enter:'; exit 1; fi
  fi
fi
if [ $HOUR -eq 22 ] || [ $HOUR -eq 10 ]; then
  cd /home/user/hdd1/lineage-21.0/
  bash repo-sync.sh
fi
cd $BASE_DIR

if bash lineage-22.sh; then
  cd /home/user/hdd1/lineage-22.0/
  if bash repo-sync.sh; then
    bash builder.sh
    if [ $? -ne 0 ]; then read -p 'lineage-22 user: press enter:'; exit 1; fi
    #bash builder-userdebug.sh
    #if [ $? -ne 0 ]; then read -p 'lineage-21 userdebug: press enter:'; exit 1; fi
  fi
fi
if [ $HOUR -eq 22 ] || [ $HOUR -eq 10 ]; then
  cd /home/user/hdd1/lineage-22.0/
  bash repo-sync.sh
fi
cd $BASE_DIR

if bash rising-6.sh; then
  cd /home/user/hdd1/rising-6/
  if bash repo-sync.sh; then
    bash builder-vanilla.sh
    if [ $? -ne 0 ]; then read -p 'lineage-21 user: press enter:'; exit 1; fi
    bash builder-gapps.sh
    if [ $? -ne 0 ]; then read -p 'lineage-21 userdebug: press enter:'; exit 1; fi
  fi
fi
if [ $HOUR -eq 22 ] || [ $HOUR -eq 10 ]; then
  cd /home/user/hdd1/rising-6/
  bash repo-sync.sh
fi
cd $BASE_DIR

echo done - `date` >> ~/build-auto.log

rm -f /home/user/build.lock
echo -e "\\a"; sleep 1;echo -e "\\a"; sleep 1;echo -e "\\a"; sleep 1;echo -e "\\a";
