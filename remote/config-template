
# For testing
source template-vanilla.sh --config=ww

# Template helper variables
export PACKAGE_NAME=crDroidAndroid-14
export VARIANT_NAME=user
export BUILD_TYPE=vanilla
export DEVICE_BRANCH=lineage-21
export VENDOR_BRANCH=lineage-21
export XIAOMI_BRANCH=lineage-21
export REPO_URL="-u https://github.com/crdroidandroid/android.git -b 14.0 --git-lfs"
export OTA_SED_STRING="crdroidandroid/android_vendor_crDroidOTA/14.0/{device}.json"

# Random template helper stuff
export BUILD_USERNAME=user
export BUILD_HOSTNAME=localhost
export KBUILD_BUILD_USER=user
export KBUILD_BUILD_HOST=localhost

download_trees () {
  rm -rf kernel/xiaomi/chime/
  rm -rf vendor/xiaomi/chime/
  rm -rf device/xiaomi/chime/
  rm -rf hardware/xiaomi/
  rm -rf prebuilts/clang/host/linux-x86/clang-stablekern/
  curl -o kernel.tar.xz -L "https://github.com/Joe7500/Builds/releases/download/Stuff/kernel.tar.xz" ; check_fail
  tar xf kernel.tar.xz ; check_fail
  rm -f kernel.tar.xz
  curl -o lineage-22.1.tar.xz -L "https://github.com/Joe7500/Builds/releases/download/Stuff/lineage-22.1.tar.xz" ; check_fail
  tar xf lineage-22.1.tar.xz ; check_fail
  rm -f lineage-22.1.tar.xz
  curl -o toolchain.tar.xz -L "https://github.com/Joe7500/Builds/releases/download/Stuff/toolchain.tar.xz" ; check_fail
  tar xf toolchain.tar.xz ; check_fail
  rm -f toolchain.tar.xz
  git clone https://github.com/Joe7500/device_xiaomi_chime.git -b $DEVICE_BRANCH device/xiaomi/chime ; check_fail
  git clone https://github.com/Joe7500/vendor_xiaomi_chime.git -b $VENDOR_BRANCH vendor/xiaomi/chime ; check_fail
  git clone https://github.com/LineageOS/android_hardware_xiaomi -b $XIAOMI_BRANCH hardware/xiaomi ; check_fail
}

setup_trees () {
  cat device/xiaomi/chime/BoardConfig.mk | grep -v TARGET_KERNEL_CLANG_VERSION > device/xiaomi/chime/BoardConfig.mk.1
  mv device/xiaomi/chime/BoardConfig.mk.1 device/xiaomi/chime/BoardConfig.mk
  echo 'TARGET_KERNEL_CLANG_VERSION := stablekern' >> device/xiaomi/chime/BoardConfig.mk
}

setup_source () {
  patch -f -p 1 < wfdservice.rc.patch ; check_fail
  cd packages/modules/Connectivity/ && git reset --hard && cd ../../../
  patch -f -p 1 < InterfaceController.java.patch ; check_fail
  rm -f InterfaceController.java.patch wfdservice.rc.patch strings.xml.*
  rm -f vendor/xiaomi/chime/proprietary/system_ext/etc/init/wfdservice.rc.rej
  rm -f packages/modules/Connectivity/staticlibs/device/com/android/net/module/util/ip/InterfaceController.java.rej

  cd packages/apps/Updater/ && git reset --hard && cd ../../../
  cp packages/apps/Updater/app/src/main/res/values/strings.xml strings.xml
  cat strings.xml | sed -e "s#$OTA_SED_STRING#Joe7500/Builds/main/$PACKAGE_NAME.$VARIANT_NAME.chime.json#g" > strings.xml.1
  cp strings.xml.1 packages/apps/Updater/app/src/main/res/values/strings.xml
  check_fail
}

build_it () {
  source build/envsetup.sh          ; check_fail
  breakfast chime user              ; check_fail
  mka installclean
  mka bacon                         ; check_fail
}

#download_trees
setup_trees
#setup_source
#build_it
